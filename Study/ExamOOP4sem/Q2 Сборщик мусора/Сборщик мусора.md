# **Сборка мусора (Garbage Collection, GC)** 
— это механизм автоматического управления памятью в платформе .NET , который освобождает разработчика от необходимости вручную выделять и освобождать память.

Он работает внутри [[Common Language Runtime (CLR)]] и следит за тем, какие объекты в памяти всё ещё используются, а какие стали недостижимыми — то есть «мусором», который можно удалить.

Функционал сборщика мусора в библиотеке классов [[Платформа .Net.|.NET]] представляет [[Классы и объекты|класс]] `System.GC`. Через [[Статические компоненты класса|статические методы]] данный класс позволяет обращаться к сборщику мусора. Как правило, надобность в применении этого класса отсутствует. Наиболее распространенным случаем его использования является сборка мусора при работе с неуправляемыми ресурсами, при интенсивном выделении больших объемов памяти, при которых необходимо такое же быстрое их освобождение.

### *Как работает сборка мусора:*
- ***Выделение памяти***. Когда создаются объекты в управляемой куче (managed heap), CLR выделяет для них место в памяти.
- ***Отслеживание достижимости объектов***. GC определяет, какие объекты всё ещё доступны из программы через активные ссылки (например, переменные, стековые вызовы, статические поля).
- ***Удаление недостижимых объектов***. Объекты, которые больше не используются, помечаются как "мертвые".
- ***Компактизация памяти*** (не всегда). После удаления таких объектов, GC может переставить оставшиеся объекты ближе друг к другу, чтобы уменьшить фрагментацию памяти. Так же надо отметить, что для крупных объектов существует своя куча - ***Large Object Heap***. В эту кучу помещаются объекты, размер которых больше 85 000 байт. Особенность этой кучи состоит в том, что при сборке мусора сжатие памяти не проводится по причине больших издержек, связанных с размером объектов.

### *Поколения объектов*
Для оптимизации работы сборщика мусора объекты делятся на три поколения:

- ***Поколение 0***. Здесь находятся вновь созданные объекты, большинство из которых недолговечны. Сборка мусора чаще всего выполняется для этого поколения.
- ***Поколение 1***. Если объекты выживают после первой сборки, они переводятся в поколение 1, которое обрабатывает объекты со средним сроком службы.
- ***Поколение 2***. Объекты, пережившие несколько сборок мусора, переходят в поколение 2, где управляются долгоживущие объекты (например, статические данные или глобальные переменные).

### *Когда запускается GC?*
Сборка мусора запускается автоматически, когда:

- Не хватает свободной памяти для новых объектов.
- Вручную вызван метод `GC.Collect()` (используется редко, так как это может снизить производительность).
- При завершении работы приложения.

### *Преимущества сборки мусора:*

- Автоматическое управление памятью.
- Уменьшение количества ошибок, связанных с памятью (например, утечки, двойное удаление и т. д.).
- Простота разработки — программист не заботится о ручном освобождении ресурсов.
### *Недостатки:*

- Может влиять на производительность (особенно при частых full GC).
- Непредсказуемость момента сборки.
- Ограниченный контроль над освобождением ресурсов (например, для файлов, сокетов и т. д.).

### *Некоторые методы и свойства класса System.GC:*

- Метод `AddMemoryPressure` информирует среду CLR о выделении большого объема неуправляемой памяти, которую надо учесть при планировании сборки мусора. В связке с этим методом используется метод RemoveMemoryPressure, который указывает CLR, что ранее выделенная память освобождена, и ее не надо учитывать при сборке мусора.
    
- Метод `Collect` приводит в действие механизм сборки мусора. Перегруженные версии метода позволяют указать поколение объектов, вплоть до которого надо произвести сборку мусора
    
- Метод `GetGeneration(Object)` позволяет определить номер поколения, к которому относится переданный в качестве параметра объект
    
- Метод `GetTotalMemory` возвращает объем памяти в байтах, которое занято в управляемой куче
    
- Метод `WaitForPendingFinalizers` приостанавливает работу текущего потока до освобождения всех объектов, для которых производится сборка мусора

##### ***Пример:***

```cs
// .................................
long totalMemory = GC.GetTotalMemory(false);
GC.Collect();
GC.WaitForPendingFinalizers();
//......................................
```
